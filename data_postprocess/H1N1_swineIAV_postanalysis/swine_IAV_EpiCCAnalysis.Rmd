---
title: "Epitope Content Comparison (EpiCC) Analysis"
author: "Tan Swan"
date: "4/29/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 8, fig.path = 'figures/')
```

###### Pre-checkpoint
```{r library, echo = TRUE}
library(tidyverse)
library(gridExtra)
library(ggplot2)
library(plotly)
library(knitr)
```
Be sure to include libraries like tidyverse, gridExtra, ggplot2, plotly and knitr.

### About EpiCC 

Epitope Content Comparison (EpiCC) - A web-based computational method that facilitates pairwise comparison of protein sequences based on immunological property, i.e. T cell epitope content, rather than sequence identity, and evaluated its ability to classify swine influenza A virus (IAV) strain relatedness to estimate cross-protective potential of a vaccine strain for circulating viruses (Guti√©rrez et. al, 2017).

#### Aim
To identify strains that have highest epitope content relatedness to the reference vaccine strain of MHC Class I/II (VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI/VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII) across H1N1 Swine IAV whole genome, i.e. a total of 8 protein segments/antigens.

#### Materials
Input to EpiCC tool: Reference vaccine sequences, MHC ClassI / II versus 72 H1N1 Swine IAV sequences of each protein segment.

Output from EpiCC tool to process and analyze: 8 outfiles for MHC Class I and II respectively.

#### Methodology/ Working steps

##### 1. Load EpiCC MHC Class I data and clean up unnecessary rows and columns

```{r Load EpiCC Class I data and clean up unnecessary rows and columns}
epicc_data_1_clsI <- read.csv("dataset/SWINEFLUH1N1_SEGMENT1_PB2_clsI_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_1_clsI <- epicc_data_1_clsI[-c(1:31),]
colnames(epicc_data_1_clsI) <- epicc_data_1_clsI[1,]
epicc_data_1_clsI <- epicc_data_1_clsI[-1,]

#Segment2 - PB1
epicc_data_2_clsI <- read.csv("dataset/SWINEFLUH1N1_SEGMENT2_PB1_clsI_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_2_clsI <- epicc_data_2_clsI[-c(1:31),]
colnames(epicc_data_2_clsI) <- epicc_data_2_clsI[1,]
epicc_data_2_clsI <- epicc_data_2_clsI[-1,]

#Segment3 - PA
epicc_data_3_clsI <- read.csv("dataset/SWINEFLUH1N1_SEGMENT3_PA_clsI_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_3_clsI <- epicc_data_3_clsI[-c(1:31),]
colnames(epicc_data_3_clsI) <- epicc_data_3_clsI[1,]
epicc_data_3_clsI <- epicc_data_3_clsI[-1,]

#Segment4 - HA
epicc_data_4_clsI <- read.csv("dataset/SWINEFLUH1N1_SEGMENT4_HA_clsI_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_4_clsI <- epicc_data_4_clsI[-c(1:31),]
colnames(epicc_data_4_clsI) <- epicc_data_4_clsI[1,]
epicc_data_4_clsI <- epicc_data_4_clsI[-1,]

#Segment5 - NP
epicc_data_5_clsI <- read.csv("dataset/SWINEFLUH1N1_SEGMENT5_NP_clsI_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_5_clsI <- epicc_data_5_clsI[-c(1:31),]
colnames(epicc_data_5_clsI) <- epicc_data_5_clsI[1,]
epicc_data_5_clsI <- epicc_data_5_clsI[-1,]

#Segment6 - NA
epicc_data_6_clsI <- read.csv("dataset/SWINEFLUH1N1_SEGMENT6_NA_clsI_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_6_clsI <- epicc_data_6_clsI[-c(1:31),]
colnames(epicc_data_6_clsI) <- epicc_data_6_clsI[1,]
epicc_data_6_clsI <- epicc_data_6_clsI[-1,]

#Segment7 - M
epicc_data_7_clsI <- read.csv("dataset/SWINEFLUH1N1_SEGMENT7_M_clsI_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_7_clsI <- epicc_data_7_clsI[-c(1:31),]
colnames(epicc_data_7_clsI) <- epicc_data_7_clsI[1,]
epicc_data_7_clsI <- epicc_data_7_clsI[-1,]

#Segment8 - NS
epicc_data_8_clsI <- read.csv("dataset/SWINEFLUH1N1_SEGMENT8_NS_clsI_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_8_clsI <- epicc_data_8_clsI[-c(1:31),]
colnames(epicc_data_8_clsI) <- epicc_data_8_clsI[1,]
epicc_data_8_clsI <- epicc_data_8_clsI[-1,]
```

###### Quick view of the processed data from one of the protein segments
```{r Quick view of the processed data from one of the protein segments, echo = TRUE}
head(colnames(epicc_data_1_clsI))
nrow(epicc_data_1_clsI)
ncol(epicc_data_1_clsI)
str(epicc_data_1_clsI)
```

```{r Transform wide form to long form data, perform sorting and extracting top 10 EpiCC score from each protein}
#PB2
#epicc_data_1_clsI$`GB_KY888027-A_SWINE_KANSAS_A01378019_2017-SEGMENT_1`
#epicc_data_1_clsI$`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`
epicc_data_1_clsI_long <- epicc_data_1_clsI %>% 
  gather(key = strains, value = PB2_score, 
         `GB_KY888027-A_SWINE_KANSAS_A01378019_2017-SEGMENT_1`:`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`) %>%
  select(strains,PB2_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_1_clsI_long$PB2_score <- as.numeric(epicc_data_1_clsI_long$PB2_score)
epicc_data_1_clsI_sort <- epicc_data_1_clsI_long %>% filter(!Sequence == "NTC8684") %>%
  arrange(Sequence) %>% arrange(desc(PB2_score))
epicc_data_1_clsI_top10 <- head(epicc_data_1_clsI_sort, 10)
epicc_data_1_clsI_top10 <- epicc_data_1_clsI_top10 %>% select(Sequence, Segment)

#PB1
#epicc_data_2_clsI$`GB_KY888028-A_SWINE_KANSAS_A01378019_2017-SEGMENT_2`
#epicc_data_2_clsI$`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`
epicc_data_2_clsI_long <- epicc_data_2_clsI %>% 
  gather(key = strains, value = PB1_score, 
         `GB_KY888028-A_SWINE_KANSAS_A01378019_2017-SEGMENT_2`:`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`) %>%
  select(strains,PB1_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_2_clsI_long$PB1_score <- as.numeric(epicc_data_2_clsI_long$PB1_score)
epicc_data_2_clsI_sort <- epicc_data_2_clsI_long %>% filter(!Sequence == "NTC8684") %>%
  arrange(Sequence) %>% arrange(desc(PB1_score))
epicc_data_2_clsI_top10 <- head(epicc_data_2_clsI_sort, 10)
epicc_data_2_clsI_top10 <- epicc_data_2_clsI_top10 %>% select(Sequence, Segment)

#PA
#epicc_data_3_clsI$`GB_KY888029-A_SWINE_KANSAS_A01378019_2017-SEGMENT_3`
#epicc_data_3_clsI$`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`
epicc_data_3_clsI_long <- epicc_data_3_clsI %>% 
  gather(key = strains, value = PA_score, 
         `GB_KY888029-A_SWINE_KANSAS_A01378019_2017-SEGMENT_3`:`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`) %>%
  select(strains,PA_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_3_clsI_long$PA_score <- as.numeric(epicc_data_3_clsI_long$PA_score)
epicc_data_3_clsI_sort <- epicc_data_3_clsI_long %>% filter(!Sequence == "NTC8684") %>%
  arrange(Sequence) %>% arrange(desc(PA_score))
epicc_data_3_clsI_top10 <- head(epicc_data_3_clsI_sort, 10)
epicc_data_3_clsI_top10 <- epicc_data_3_clsI_top10 %>% select(Sequence, Segment)

#HA
#epicc_data_4_clsI$`GB_KY522877-A_SWINE_NORTH_CAROLINA_A01672011_2017-SEGMENT_4`
#epicc_data_4_clsI$`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`
epicc_data_4_clsI_long <- epicc_data_4_clsI %>% 
  gather(key = strains, value = HA_score, 
         `GB_KY522877-A_SWINE_NORTH_CAROLINA_A01672011_2017-SEGMENT_4`:`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`) %>%
  select(strains,HA_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_4_clsI_long$HA_score <- as.numeric(epicc_data_4_clsI_long$HA_score)
epicc_data_4_clsI_sort <- epicc_data_4_clsI_long %>% filter(!Sequence == "NTC8684") %>%
  arrange(Sequence) %>% arrange(desc(HA_score))
epicc_data_4_clsI_top10 <- head(epicc_data_4_clsI_sort, 10)
epicc_data_4_clsI_top10 <- epicc_data_4_clsI_top10 %>% select(Sequence, Segment)

#NP
#epicc_data_5_clsI$`GB_KY888031-A_SWINE_KANSAS_A01378019_2017-SEGMENT_5`
#epicc_data_5_clsI$`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`
epicc_data_5_clsI_long <- epicc_data_5_clsI %>% 
  gather(key = strains, value = NP_score, 
         `GB_KY888031-A_SWINE_KANSAS_A01378019_2017-SEGMENT_5`:`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`) %>%
  select(strains,NP_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_5_clsI_long$NP_score <- as.numeric(epicc_data_5_clsI_long$NP_score)
epicc_data_5_clsI_sort <- epicc_data_5_clsI_long %>% filter(!Sequence == "NTC8684") %>%
  arrange(Sequence) %>% arrange(desc(NP_score))
epicc_data_5_clsI_top10 <- head(epicc_data_5_clsI_sort, 10)
epicc_data_5_clsI_top10 <- epicc_data_5_clsI_top10 %>% select(Sequence, Segment)

#NA
#epicc_data_6_clsI$`GB_KY522878-A_SWINE_NORTH_CAROLINA_A01672011_2017-SEGMENT_6`
#epicc_data_6_clsI$`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`
epicc_data_6_clsI_long <- epicc_data_6_clsI %>% 
  gather(key = strains, value = NA_score, 
         `GB_KY522878-A_SWINE_NORTH_CAROLINA_A01672011_2017-SEGMENT_6`:`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`) %>%
  select(strains,NA_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_6_clsI_long$NA_score <- as.numeric(epicc_data_6_clsI_long$NA_score)
epicc_data_6_clsI_sort <- epicc_data_6_clsI_long %>% filter(!Sequence == "NTC8684") %>%
  arrange(Sequence) %>% arrange(desc(NA_score))
epicc_data_6_clsI_top10 <- head(epicc_data_6_clsI_sort, 10)
epicc_data_6_clsI_top10 <- epicc_data_6_clsI_top10 %>% select(Sequence, Segment)

#M
#epicc_data_7_clsI$`GB_KY888033-A_SWINE_KANSAS_A01378019_2017-SEGMENT_7`
#epicc_data_7_clsI$`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`
epicc_data_7_clsI_long <- epicc_data_7_clsI %>% 
  gather(key = strains, value = M_score, 
         `GB_KY888033-A_SWINE_KANSAS_A01378019_2017-SEGMENT_7`:`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`) %>%
  select(strains,M_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_7_clsI_long$M_score <- as.numeric(epicc_data_7_clsI_long$M_score)
epicc_data_7_clsI_sort <- epicc_data_7_clsI_long %>% filter(!Sequence == "NTC8684") %>%
  #select(Sequence, M_score, Segment, Subtype) %>%
  arrange(Sequence) %>% arrange(desc(M_score))
epicc_data_7_clsI_top10 <- head(epicc_data_7_clsI_sort, 10)
epicc_data_7_clsI_top10 <- epicc_data_7_clsI_top10 %>% select(Sequence, Segment)

#NS
#epicc_data_8_clsI$`GB_KY888034-A_SWINE_KANSAS_A01378019_2017-SEGMENT_8`
#epicc_data_8_clsI$`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`
epicc_data_8_clsI_long <- epicc_data_8_clsI %>% 
  gather(key = strains, value = NS_score, 
         `GB_KY888034-A_SWINE_KANSAS_A01378019_2017-SEGMENT_8`:`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`) %>%
  select(strains,NS_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_8_clsI_long$NS_score <- as.numeric(epicc_data_8_clsI_long$NS_score)
epicc_data_8_clsI_sort <- epicc_data_8_clsI_long %>% filter(!Sequence == "NTC8684") %>%
  arrange(Sequence) %>% arrange(desc(NS_score))
epicc_data_8_clsI_top10 <- head(epicc_data_8_clsI_sort, 10)
epicc_data_8_clsI_top10 <- epicc_data_8_clsI_top10 %>% select(Sequence, Segment)
```

##### 2. Transform data from wide form to long form, perform sorting and extracting top 10 EpiCC score from each protein

###### Showing a working example from one of the protein segments: PB2
```{r Quick view of one of the processed data, echo = TRUE}
epicc_data_1_clsI_long <- epicc_data_1_clsI %>% 
  gather(key = strains, value = PB2_score, 
         `GB_KY888027-A_SWINE_KANSAS_A01378019_2017-SEGMENT_1`:`VACCINE_EPITOPES_CLASSI-NTC8684-ERNA41H-7SOJI`) %>% 
  select(strains,PB2_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_1_clsI_long$PB2_score <- as.numeric(epicc_data_1_clsI_long$PB2_score)
epicc_data_1_clsI_sort <- epicc_data_1_clsI_long %>% filter(!Sequence == "NTC8684") %>%
  arrange(Sequence) %>% arrange(desc(PB2_score))
epicc_data_1_clsI_top10 <- head(epicc_data_1_clsI_sort, 10)
epicc_data_1_clsI_top10 <- epicc_data_1_clsI_top10 %>% select(Sequence, Segment)
epicc_data_1_clsI_top10
```

##### 2a. Exploratory analysis of H1N1 Swine IAV dataset
```{r Area distribution}
metadata_1 <- epicc_data_1_clsI_long %>% select(Sequence) %>% filter(!Sequence == "NTC8684") %>%
  separate(Sequence, into = c("FluType", "Host", "Area", "FluID", "Year"), sep = "_", extra = "merge")
x <- which(metadata_1$FluID == "CAROLINA")
metadata_1$Area[c(7,17,38,59,69)] <- "NORTH CAROLINA"
metadata_1$FluID[c(7,17,38,59,69)] <- c("A01672011", "A01672751", "A02214775", "A01785281", "A01785282")
metadata_1$Year[c(7,17,38,59,69)] <- "2017"
#subtype_info <- metadata_1 %>% filter(Subtype == "Challenge") %>% group_by(Subtype) %>% tally()
area_info <- metadata_1 %>% group_by(Area) %>% tally() %>% arrange(desc(n))

#area info pie chart
plot_ly(area_info, labels = ~Area, values = ~n, type = 'pie',textposition = 'inside',
        domain = list(x = c(0, 0), y = c(0, 0)), textinfo = 'label+percent',
        rotation = -125, direction = "clockwise", 
        textfont = list(color = '#000000', size = 16)) %>%
  layout(title = 'Area Distribution of Swine IAV Dataset', xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE), yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE, tickformat = "%"))
```


```{r Combine top 10 EpiCC score from each protein}
epicc_data_clsI_top10_all <- rbind.data.frame(epicc_data_1_clsI_top10, epicc_data_2_clsI_top10,
                                               epicc_data_3_clsI_top10, epicc_data_4_clsI_top10,
                                               epicc_data_5_clsI_top10, epicc_data_6_clsI_top10,
                                               epicc_data_7_clsI_top10, epicc_data_8_clsI_top10)
```

##### 3. Combine top 10 EpiCC score from each protein

###### MHC Class I top 10 data preview
```{r Preview 3, echo = TRUE}
head(epicc_data_clsI_top10_all)
tail(epicc_data_clsI_top10_all)
unique(epicc_data_clsI_top10_all$Sequence)
unique(epicc_data_clsI_top10_all$Segment)
```

##### 4. Identify the most occuring strains, i.e. strains with high frequency
```{r To identify the most occuring strains, i.e. strains with high frequency}
most_occurence_strain_clsI <- epicc_data_clsI_top10_all %>% group_by(Sequence) %>% summarise(count = n()) %>% arrange(desc(count)) %>% filter(count >= 3)
```

```{r To identify the most occuring strains, echo = TRUE}
max(most_occurence_strain_clsI$count)
most_occurence_strain_clsI
```
Maximum frequency = 5 out of 8 (if the EpiCC score of a strain remain in the top 10 list of all proteins, then it will have frequency of 8). In this case, since the maximum frequency is only 5, this means that these strains are only found in the top 10 list of 5 proteins. Here, we considered strains that of frequency between 3 - 5. 

##### 5. Repeat steps 1 - 4 for MHC Class II data

```{r Load EpiCC Class II data}
#load EpiCC data - Class II
#Segment1 - PB2
epicc_data_1_clsII <- read.csv("dataset/SWINEFLUH1N1_SEGMENT1_PB2_clsII_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_1_clsII <- epicc_data_1_clsII[-c(1:31),]
colnames(epicc_data_1_clsII) <- epicc_data_1_clsII[1,]
epicc_data_1_clsII <- epicc_data_1_clsII[-1,]

#Segment2 - PB1
epicc_data_2_clsII <- read.csv("dataset/SWINEFLUH1N1_SEGMENT2_PB1_clsII_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_2_clsII <- epicc_data_2_clsII[-c(1:31),]
colnames(epicc_data_2_clsII) <- epicc_data_2_clsII[1,]
epicc_data_2_clsII <- epicc_data_2_clsII[-1,]

#Segment3 - PA
epicc_data_3_clsII <- read.csv("dataset/SWINEFLUH1N1_SEGMENT3_PA_clsII_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_3_clsII <- epicc_data_3_clsII[-c(1:31),]
colnames(epicc_data_3_clsII) <- epicc_data_3_clsII[1,]
epicc_data_3_clsII <- epicc_data_3_clsII[-1,]

#Segment4 - HA
epicc_data_4_clsII <- read.csv("dataset/SWINEFLUH1N1_SEGMENT4_HA_clsII_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_4_clsII <- epicc_data_4_clsII[-c(1:31),]
colnames(epicc_data_4_clsII) <- epicc_data_4_clsII[1,]
epicc_data_4_clsII <- epicc_data_4_clsII[-1,]

#Segment5 - NP
epicc_data_5_clsII <- read.csv("dataset/SWINEFLUH1N1_SEGMENT5_NP_clsII_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_5_clsII <- epicc_data_5_clsII[-c(1:31),]
colnames(epicc_data_5_clsII) <- epicc_data_5_clsII[1,]
epicc_data_5_clsII <- epicc_data_5_clsII[-1,]

#Segment6 - NA
epicc_data_6_clsII <- read.csv("dataset/SWINEFLUH1N1_SEGMENT6_NA_clsII_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_6_clsII <- epicc_data_6_clsII[-c(1:31),]
colnames(epicc_data_6_clsII) <- epicc_data_6_clsII[1,]
epicc_data_6_clsII <- epicc_data_6_clsII[-1,]

#Segment7 - M
epicc_data_7_clsII <- read.csv("dataset/SWINEFLUH1N1_SEGMENT7_M_clsII_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_7_clsII <- epicc_data_7_clsII[-c(1:31),]
colnames(epicc_data_7_clsII) <- epicc_data_7_clsII[1,]
epicc_data_7_clsII <- epicc_data_7_clsII[-1,]

#Segment8 - NS
epicc_data_8_clsII <- read.csv("dataset/SWINEFLUH1N1_SEGMENT8_NS_clsII_ALL_INFO.csv", header = FALSE, stringsAsFactors = FALSE, sep = ",")
epicc_data_8_clsII <- epicc_data_8_clsII[-c(1:31),]
colnames(epicc_data_8_clsII) <- epicc_data_8_clsII[1,]
epicc_data_8_clsII <- epicc_data_8_clsII[-1,]

#transform wide form data to long form data
#PB2
#epicc_data_1_clsII$`GB_KY888027-A_SWINE_KANSAS_A01378019_2017-SEGMENT_1`
#epicc_data_1_clsII$`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`
epicc_data_1_clsII_long <- epicc_data_1_clsII %>% 
  gather(key = strains, value = PB2_score, 
         `GB_KY888027-A_SWINE_KANSAS_A01378019_2017-SEGMENT_1`:`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`) %>%
  select(strains,PB2_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_1_clsII_long$PB2_score <- as.numeric(epicc_data_1_clsII_long$PB2_score)
epicc_data_1_clsII_sort <- epicc_data_1_clsII_long %>% filter(!Sequence == "NTC8682") %>%
  arrange(Sequence) %>% arrange(desc(PB2_score))
epicc_data_1_clsII_top10 <- head(epicc_data_1_clsII_sort, 10)
epicc_data_1_clsII_top10 <- epicc_data_1_clsII_top10 %>% select(Sequence, Segment)

#PB1
#epicc_data_2_clsII$`GB_KY888028-A_SWINE_KANSAS_A01378019_2017-SEGMENT_2`
#epicc_data_2_clsII$`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`
epicc_data_2_clsII_long <- epicc_data_2_clsII %>% 
  gather(key = strains, value = PB1_score, 
         `GB_KY888028-A_SWINE_KANSAS_A01378019_2017-SEGMENT_2`:`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`) %>%
  select(strains,PB1_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_2_clsII_long$PB1_score <- as.numeric(epicc_data_2_clsII_long$PB1_score)
epicc_data_2_clsII_sort <- epicc_data_2_clsII_long %>% filter(!Sequence == "NTC8682") %>%
  arrange(Sequence) %>% arrange(desc(PB1_score))
epicc_data_2_clsII_top10 <- head(epicc_data_2_clsII_sort, 10)
epicc_data_2_clsII_top10 <- epicc_data_2_clsII_top10 %>% select(Sequence, Segment)

#PA
#epicc_data_3_clsII$`GB_KY888029-A_SWINE_KANSAS_A01378019_2017-SEGMENT_3`
#epicc_data_3_clsII$`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`
epicc_data_3_clsII_long <- epicc_data_3_clsII %>% 
  gather(key = strains, value = PA_score, 
         `GB_KY888029-A_SWINE_KANSAS_A01378019_2017-SEGMENT_3`:`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`) %>%
  select(strains,PA_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_3_clsII_long$PA_score <- as.numeric(epicc_data_3_clsII_long$PA_score)
epicc_data_3_clsII_sort <- epicc_data_3_clsII_long %>% filter(!Sequence == "NTC8682") %>%
  arrange(Sequence) %>% arrange(desc(PA_score))
epicc_data_3_clsII_top10 <- head(epicc_data_3_clsII_sort, 10)
epicc_data_3_clsII_top10 <- epicc_data_3_clsII_top10 %>% select(Sequence, Segment)

#HA
#epicc_data_4_clsII$`GB_KY522877-A_SWINE_NORTH_CAROLINA_A01672011_2017-SEGMENT_4`
#epicc_data_4_clsII$`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`
epicc_data_4_clsII_long <- epicc_data_4_clsII %>% 
  gather(key = strains, value = HA_score, 
         `GB_KY522877-A_SWINE_NORTH_CAROLINA_A01672011_2017-SEGMENT_4`:`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`) %>%
  select(strains,HA_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_4_clsII_long$HA_score <- as.numeric(epicc_data_4_clsII_long$HA_score)
epicc_data_4_clsII_sort <- epicc_data_4_clsII_long %>% filter(!Sequence == "NTC8682") %>%
  arrange(Sequence) %>% arrange(desc(HA_score))
epicc_data_4_clsII_top10 <- head(epicc_data_4_clsII_sort, 10)
epicc_data_4_clsII_top10 <- epicc_data_4_clsII_top10 %>% select(Sequence, Segment)

#NP
#epicc_data_5_clsII$`GB_KY888031-A_SWINE_KANSAS_A01378019_2017-SEGMENT_5`
#epicc_data_5_clsII$`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`
epicc_data_5_clsII_long <- epicc_data_5_clsII %>% 
  gather(key = strains, value = NP_score, 
         `GB_KY888031-A_SWINE_KANSAS_A01378019_2017-SEGMENT_5`:`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`) %>%
  select(strains,NP_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_5_clsII_long$NP_score <- as.numeric(epicc_data_5_clsII_long$NP_score)
epicc_data_5_clsII_sort <- epicc_data_5_clsII_long %>% filter(!Sequence == "NTC8682") %>%
  arrange(Sequence) %>% arrange(desc(NP_score))
epicc_data_5_clsII_top10 <- head(epicc_data_5_clsII_sort, 10)
epicc_data_5_clsII_top10 <- epicc_data_5_clsII_top10 %>% select(Sequence, Segment)

#NA
#epicc_data_6_clsII$`GB_KY522878-A_SWINE_NORTH_CAROLINA_A01672011_2017-SEGMENT_6`
#epicc_data_6_clsII$`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`
epicc_data_6_clsII_long <- epicc_data_6_clsII %>% 
  gather(key = strains, value = NA_score, 
         `GB_KY522878-A_SWINE_NORTH_CAROLINA_A01672011_2017-SEGMENT_6`:`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`) %>%
  select(strains,NA_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_6_clsII_long$NA_score <- as.numeric(epicc_data_6_clsII_long$NA_score)
epicc_data_6_clsII_sort <- epicc_data_6_clsII_long %>% filter(!Sequence == "NTC8682") %>%
  arrange(Sequence) %>% arrange(desc(NA_score))
epicc_data_6_clsII_top10 <- head(epicc_data_6_clsII_sort, 10)
epicc_data_6_clsII_top10 <- epicc_data_6_clsII_top10 %>% select(Sequence, Segment)

#M
#epicc_data_7_clsII$`GB_KY888033-A_SWINE_KANSAS_A01378019_2017-SEGMENT_7`
#epicc_data_7_clsII$`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`
epicc_data_7_clsII_long <- epicc_data_7_clsII %>% 
  gather(key = strains, value = M_score, 
         `GB_KY888033-A_SWINE_KANSAS_A01378019_2017-SEGMENT_7`:`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`) %>%
  select(strains,M_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_7_clsII_long$M_score <- as.numeric(epicc_data_7_clsII_long$M_score)
epicc_data_7_clsII_sort <- epicc_data_7_clsII_long %>% filter(!Sequence == "NTC8682") %>%
  arrange(Sequence) %>% arrange(desc(M_score))
epicc_data_7_clsII_top10 <- head(epicc_data_7_clsII_sort, 10)
epicc_data_7_clsII_top10 <- epicc_data_7_clsII_top10 %>% select(Sequence, Segment)

#NS
#epicc_data_8_clsII$`GB_KY888034-A_SWINE_KANSAS_A01378019_2017-SEGMENT_8`
#epicc_data_8_clsII$`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`
epicc_data_8_clsII_long <- epicc_data_8_clsII %>% 
  gather(key = strains, value = NS_score, 
         `GB_KY888034-A_SWINE_KANSAS_A01378019_2017-SEGMENT_8`:`VACCINE_EPITOPES_CLASSII-NTC8682-ERNA41H-1SOJII`) %>%
  select(strains,NS_score) %>% mutate(header = strains) %>% 
  separate(header, into = c("ID", "Sequence", "Segment"), sep = "-", extra = "merge")
epicc_data_8_clsII_long$NS_score <- as.numeric(epicc_data_8_clsII_long$NS_score)
epicc_data_8_clsII_sort <- epicc_data_8_clsII_long %>% filter(!Sequence == "NTC8682") %>%
  arrange(Sequence) %>% arrange(desc(NS_score))
epicc_data_8_clsII_top10 <- head(epicc_data_8_clsII_sort, 10)
epicc_data_8_clsII_top10 <- epicc_data_8_clsII_top10 %>% select(Sequence, Segment)
```

```{r To identify the most occuring strains for Class II}
epicc_data_clsII_top10_all <- rbind.data.frame(epicc_data_1_clsII_top10,epicc_data_2_clsII_top10,
                                               epicc_data_3_clsII_top10,epicc_data_4_clsII_top10,
                                               epicc_data_5_clsII_top10,epicc_data_6_clsII_top10,
                                               epicc_data_7_clsII_top10,epicc_data_8_clsII_top10)
most_occurence_strain_clsII <- epicc_data_clsII_top10_all %>% group_by(Sequence) %>% summarise(count = n()) %>%
  arrange(desc(count)) %>% filter(count >= 3)
```

##### MHC Class II top 10 data preview
```{r Preview 5, echo = TRUE}
head(epicc_data_clsII_top10_all)
tail(epicc_data_clsII_top10_all)
unique(epicc_data_clsII_top10_all$Sequence)
unique(epicc_data_clsII_top10_all$Segment)
```

```{r Preview 6, echo = TRUE}
max(most_occurence_strain_clsII$count)
most_occurence_strain_clsII
```
Maximum frequency = 7 out of 8. Same selection criteria as Class I data, we considered strains that of frequency between 3 - 5.

##### 6. To plot the frequency of MHC Class I/II top 10 strains from all 8 proteins
```{r plotting}
epicc_data_clsI_top10_all <- epicc_data_clsI_top10_all %>% group_by(Sequence) %>% summarise(count = n()) %>%
  arrange(desc(count))
epicc_data_clsII_top10_all <- epicc_data_clsII_top10_all %>% group_by(Sequence) %>% summarise(count = n()) %>%
  arrange(desc(count))

epicc_data_clsI_top10_all$Sequence <- factor(epicc_data_clsI_top10_all$Sequence, 
                                        levels = epicc_data_clsI_top10_all$Sequence[order(-epicc_data_clsI_top10_all$count)])
plot_clsI <- ggplot(epicc_data_clsI_top10_all, aes(x = Sequence, y = count)) + 
  geom_bar(stat = "identity") + theme_classic() +
  theme(legend.position = "right") +
  labs(title = "EpiCC Result \n Top Matched H1N1 Swine IAV Strains \n (Class I)", 
       x = "Strains", y = "Count (n)") +
  theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
  theme(axis.text.x = element_text(angle = 72, hjust = 1, size = 7)) +
  theme(axis.text.y = element_text(size = 9))

epicc_data_clsII_top10_all$Sequence <- factor(epicc_data_clsII_top10_all$Sequence, 
                                        levels = epicc_data_clsII_top10_all$Sequence[order(-epicc_data_clsII_top10_all$count)])
plot_clsII <- ggplot(epicc_data_clsII_top10_all, aes(x = Sequence, y = count)) + 
  geom_bar(stat = "identity") + theme_classic() +
  theme(legend.position = "right") +
  labs(title = "Top Matched H1N1 Swine IAV Strains \n (Class II)", 
       x = "Strains", y = "Count (n)") +
  theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
  theme(axis.text.x = element_text(angle = 72, hjust = 1, size = 7)) +
  theme(axis.text.y = element_text(size = 9))

grid.arrange(plot_clsI, plot_clsII, nrow = 2)
```
This figure shows strains that are found in the top 10 list of every proteins and their frequencies were counted. This is to identify strains that are constantly having high EpiCC score across the whole genome.

Upper panel shows there are 3 strains have a frequency of 5; 6 strains of frequency 4; 3 strains of frequency 3; 6 strains of frequency 2 and 20 strains of frequency 1.

Lower panel shows there is 1 strain has frequency of 7 and 6, respectively; 4 strains of frequency 4; 8 strains of frequency 3; 5 strains of frequency 2 and 17 strains of frequency 1.  


##### 7. Identify strains that are common in both Class I and Class II
```{r To find common strains}
epicc_overlap <- most_occurence_strain_clsII$Sequence %in% most_occurence_strain_clsI$Sequence 
epicc_common <- most_occurence_strain_clsII[overlap,]
```

#### EpiCC Result
```{r Overlapping strains, echo = TRUE}
epicc_common
```
There are 8 Swine IAV found in both Class I and Class II top EpiCC score list. This means 8 of these strains are having relatively high epitope content to the reference vaccine strain compared to other H1N1 Swine IAV sequences.
